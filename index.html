<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FIFA Song Ranker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
      background: #f7f7f7;
    }
    h1 {
      color: #1db954;
    }
    #loginBtn, #loadBtn {
      padding: 10px 15px;
      background-color: #1db954;
      color: white;
      border: none;
      border-radius: 5px;
      margin-top: 20px;
      cursor: pointer;
    }
    .song-container, .ranking-board {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 30px;
    }
    .song {
      display: flex;
      align-items: center;
      background: white;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 10px;
      justify-content: space-between;
    }
    .song img {
      height: 60px;
      width: 60px;
      margin-right: 15px;
      border-radius: 6px;
    }
    .song-details {
      display: flex;
      flex-direction: column;
    }
    .song-details a {
      text-decoration: none;
      color: #1db954;
      font-weight: bold;
    }
    .controls button {
      margin-left: 10px;
      padding: 5px 10px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>üéµ FIFA Song Ranker</h1>
  <p>Login with Spotify Premium and paste a playlist link to rank the songs.</p>

  <button id="loginBtn">Login with Spotify</button>
  <br />
  <input id="playlistInput" type="text" placeholder="Paste Spotify Playlist URL here" style="margin-top:20px;width:100%;padding:10px;" />
  <button id="loadBtn">Load Playlist Songs</button>

  <h2>All Playlist Songs</h2>
  <div id="songList" class="song-container"></div>

  <h2>üèÜ Top 100 Ranking</h2>
  <div id="rankingBoard" class="ranking-board"></div>

  <script>
    let token = null;
    let player;

    document.getElementById('loginBtn').addEventListener('click', () => {
      const clientId = '7ca36959578b4e96ad42dc422222237e';
      const redirectUri = 'https://senaiyohanness.github.io/Fifa-Ranker-12-21-Plus/';
      const scopes = [
        'streaming',
        'user-read-email',
        'user-read-private',
        'user-modify-playback-state',
        'user-read-playback-state'
      ];
      const authUrl = `https://accounts.spotify.com/authorize?client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&scope=${scopes.join('%20')}&response_type=token&show_dialog=true`;
      window.location = authUrl;
    });

    document.getElementById('loadBtn').addEventListener('click', async () => {
      const url = document.getElementById('playlistInput').value.trim();
      const match = url.match(/playlist\/(\w+)/);
      if (!match || !token) {
        alert("Invalid playlist URL or not authenticated.");
        return;
      }

      const playlistId = match[1];
      const response = await fetch(`https://api.spotify.com/v1/playlists/${playlistId}/tracks`, {
        headers: {
          Authorization: `Bearer ${token}`
        }
      });

      if (!response.ok) {
        alert("Failed to fetch playlist: " + response.status);
        return;
      }

      const data = await response.json();
      const songList = document.getElementById('songList');
      songList.innerHTML = '';

      data.items.forEach((item, index) => {
        const track = item.track;
        const container = document.createElement('div');
        container.className = 'song';
        container.innerHTML = `
          <img src="${track.album.images[0]?.url}" alt="Album Art">
          <div class="song-details">
            <a href="${track.external_urls.spotify}" target="_blank">${track.name}</a>
            <span>${track.artists.map(artist => artist.name).join(', ')}</span>
          </div>
        `;
        songList.appendChild(container);
      });
    });

    window.addEventListener('load', () => {
      const hash = window.location.hash.substring(1);
      const params = new URLSearchParams(hash);
      token = params.get('access_token');
      if (token) {
        window.onSpotifyWebPlaybackSDKReady = () => {
          player = new Spotify.Player({
            name: 'FIFA Ranker Web Player',
            getOAuthToken: cb => { cb(token); },
            volume: 0.5
          });

          player.addListener('ready', ({ device_id }) => {
            console.log('Player is ready with Device ID', device_id);
            setTimeout(() => {
              fetch('https://api.spotify.com/v1/me/player', {
                method: 'PUT',
                body: JSON.stringify({ device_ids: [device_id], play: false }),
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${token}`
                }
              });
            }, 1000);
          });

          player.addListener('not_ready', ({ device_id }) => {
            console.error('Device ID has gone offline', device_id);
          });

          player.addListener('initialization_error', ({ message }) => {
            console.error('Initialization error:', message);
          });

          player.addListener('authentication_error', ({ message }) => {
            console.error('Authentication error:', message);
          });

          player.addListener('account_error', ({ message }) => {
            console.error('Account error:', message);
          });

          player.connect();
        };
      }
    });
  </script>
  <script src="https://sdk.scdn.co/spotify-player.js"></script>
</body>
</html>
